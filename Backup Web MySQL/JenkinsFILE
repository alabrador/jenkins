pipeline {
    agent any
    environment {
        REMOTE_HOST = credentials('REMOTE_HOST_APRONTO')
        REMOTE_PORT = credentials('REMOTE_PORT_APRONTO')
        DB_NAME = credentials('DB_NAME_SECRET')
    }
    stages {
        stage('Preparar backup local') {
            steps {
                sh 'mkdir -p ${WORKSPACE}/backups'
            }
        }
        stage('Backup remoto') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'mysql_cred_apronto', usernameVariable: 'MYSQL_USER', passwordVariable: 'MYSQL_PASS')]) {
                    sshagent(['remote_ssh_apronto']) {
                        script {
                            def timestamp = sh(script: 'date +%F_%H-%M-%S', returnStdout: true).trim()
                            def backupFile = "${DB_NAME}_${timestamp}.sql.gz"

                            // Realizar mysqldump remoto y comprimir
                            sh(script: """
                                ssh -p ${REMOTE_PORT} ${REMOTE_HOST} \\
                                "mysqldump -u${MYSQL_USER} -p'${MYSQL_PASS}' ${DB_NAME} | gzip > /tmp/${backupFile}"
                            """)

                            // Copiar el backup al workspace local
                            sh(script: "scp -P ${REMOTE_PORT} ${REMOTE_HOST}:/tmp/${backupFile} ${WORKSPACE}/backups/")

                            // Limpiar backups remotos con más de 7 días
                            sh(script: """
                                ssh -p ${REMOTE_PORT} ${REMOTE_HOST} \\
                                'find /tmp -type f -name "${DB_NAME}_*.sql.gz" -mtime +7 -exec rm -f {} \\\\;'
                            """)
                        }
                    }
                }
            }
        }
        stage('Limpiar backups locales antiguos') {
            steps {
                sh(script: """
                    find ${WORKSPACE}/backups -type f -name "${DB_NAME}_*.sql.gz" -mtime +7 -exec rm -f {} \\\\;
                """)
            }
        }
    }
    post {
        success {
            echo "✅ Backup completado correctamente"
        }
        failure {
            echo "❌ Falló el backup"
        }
    }
}
